rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is a platform admin
    function isPlatformAdmin() {
      return isAuthenticated() && (
        request.auth.token.email.lower() == 'merchantai@gmail.com' || 
        request.auth.token.email.lower() == 'admin@merchantai.com'
      );
    }

    // Helper to check hotel ownership
    function isHotelOwner(hotelId) {
      let hotelData = (hotelId != null) ? get(/databases/$(database)/documents/hotels/$(hotelId)).data : resource.data;
      return isAuthenticated() && (
        hotelData.ownerEmail is list ? 
        request.auth.token.email.lower() in hotelData.ownerEmail : 
        request.auth.token.email.lower() == hotelData.ownerEmail.lower()
      );
    }
    
    match /hotels/{hotelId} {
      allow read: if true;
      
      // Platform admins can do anything. Owners can update their own shop.
      // For create, we check request.resource.data
      allow create: if isPlatformAdmin(); 
      allow update, delete: if isPlatformAdmin() || isHotelOwner(null);

      match /menu/{menuId} {
        allow read: if true;
        allow write: if isPlatformAdmin() || isHotelOwner(hotelId);
      }
    }
  }
}
